{% extends 'final/base.html' %}
{% block title %}入出庫履歴{% endblock %}
{% block content %}
<h2>入出庫履歴</h2>

<!-- 操作ヒント -->
<div class="alert alert-info" role="alert">
  <strong>ヒント:</strong> 日付範囲や商品名などで絞り込み、列ヘッダーをクリックして並び替えができます。<br>
  備考欄はクリックで全文を確認できます。
</div>

<!-- フィルター検索フォーム -->
<form method="get" class="mb-3 row g-2 align-items-center" novalidate>
  <div class="col-auto">
    <input type="date" name="date_from" value="{{ request.GET.date_from }}" class="form-control form-control-sm" placeholder="開始日" data-bs-toggle="tooltip" data-bs-placement="top" title="開始日で絞り込み">
  </div>
  <div class="col-auto">
    <input type="date" name="date_to" value="{{ request.GET.date_to }}" class="form-control form-control-sm" placeholder="終了日" data-bs-toggle="tooltip" data-bs-placement="top" title="終了日で絞り込み">
  </div>
  <div class="col-auto">
    <input type="text" name="product" value="{{ request.GET.product }}" placeholder="商品名" class="form-control form-control-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="商品名で絞り込み">
  </div>
  <div class="col-auto">
    <select name="movement_type" class="form-select form-select-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="入庫／出庫で絞り込み">
      <option value="">種別</option>
      <option value="in" {% if request.GET.movement_type == "in" %}selected{% endif %}>入庫</option>
      <option value="out" {% if request.GET.movement_type == "out" %}selected{% endif %}>出庫</option>
    </select>
  </div>
  <div class="col-auto">
    <input type="text" name="operated_by" value="{{ request.GET.operated_by }}" placeholder="担当者" class="form-control form-control-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="担当者名で絞り込み">
  </div>
  <div class="col-auto">
    <button type="submit" class="btn btn-primary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="絞り込み検索を実行">検索</button>
  </div>
</form>

<!-- テーブル -->
<div class="table-responsive">
<table class="table table-striped table-hover align-middle">
  <thead class="table-dark">
    <tr>
      <!-- シンプルにソートリンクを条件分岐で作成 -->
      <th>
        {% if request.GET.sort == "timestamp" %}
          {% if request.GET.order == "asc" %}
            <a href="?sort=timestamp&order=desc{% if request.GET.product %}&product={{ request.GET.product }}{% endif %}{% if request.GET.movement_type %}&movement_type={{ request.GET.movement_type }}{% endif %}{% if request.GET.operated_by %}&operated_by={{ request.GET.operated_by }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">日時 ▲</a>
          {% else %}
            <a href="?sort=timestamp&order=asc{% if request.GET.product %}&product={{ request.GET.product }}{% endif %}{% if request.GET.movement_type %}&movement_type={{ request.GET.movement_type }}{% endif %}{% if request.GET.operated_by %}&operated_by={{ request.GET.operated_by }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">日時 ▼</a>
          {% endif %}
        {% else %}
          <a href="?sort=timestamp&order=asc{% if request.GET.product %}&product={{ request.GET.product }}{% endif %}{% if request.GET.movement_type %}&movement_type={{ request.GET.movement_type }}{% endif %}{% if request.GET.operated_by %}&operated_by={{ request.GET.operated_by }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">日時</a>
        {% endif %}
      </th>

      <th>
        {% if request.GET.sort == "product__name" %}
          {% if request.GET.order == "asc" %}
            <a href="?sort=product__name&order=desc{% if request.GET.product %}&product={{ request.GET.product }}{% endif %}{% if request.GET.movement_type %}&movement_type={{ request.GET.movement_type }}{% endif %}{% if request.GET.operated_by %}&operated_by={{ request.GET.operated_by }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">商品 ▲</a>
          {% else %}
            <a href="?sort=product__name&order=asc{% if request.GET.product %}&product={{ request.GET.product }}{% endif %}{% if request.GET.movement_type %}&movement_type={{ request.GET.movement_type }}{% endif %}{% if request.GET.operated_by %}&operated_by={{ request.GET.operated_by }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">商品 ▼</a>
          {% endif %}
        {% else %}
          <a href="?sort=product__name&order=asc{% if request.GET.product %}&product={{ request.GET.product }}{% endif %}{% if request.GET.movement_type %}&movement_type={{ request.GET.movement_type }}{% endif %}{% if request.GET.operated_by %}&operated_by={{ request.GET.operated_by }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">商品</a>
        {% endif %}
      </th>

      <th>
        {% if request.GET.sort == "movement_type" %}
          {% if request.GET.order == "asc" %}
            <a href="?sort=movement_type&order=desc{% if request.GET.product %}&product={{ request.GET.product }}{% endif %}{% if request.GET.movement_type %}&movement_type={{ request.GET.movement_type }}{% endif %}{% if request.GET.operated_by %}&operated_by={{ request.GET.operated_by }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">種別 ▲</a>
          {% else %}
            <a href="?sort=movement_type&order=asc{% if request.GET.product %}&product={{ request.GET.product }}{% endif %}{% if request.GET.movement_type %}&movement_type={{ request.GET.movement_type }}{% endif %}{% if request.GET.operated_by %}&operated_by={{ request.GET.operated_by }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">種別 ▼</a>
          {% endif %}
        {% else %}
          <a href="?sort=movement_type&order=asc{% if request.GET.product %}&product={{ request.GET.product }}{% endif %}{% if request.GET.movement_type %}&movement_type={{ request.GET.movement_type }}{% endif %}{% if request.GET.operated_by %}&operated_by={{ request.GET.operated_by }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">種別</a>
        {% endif %}
      </th>

      <th class="text-end">
        {% if request.GET.sort == "quantity" %}
          {% if request.GET.order == "asc" %}
            <a href="?sort=quantity&order=desc{% if request.GET.product %}&product={{ request.GET.product }}{% endif %}{% if request.GET.movement_type %}&movement_type={{ request.GET.movement_type }}{% endif %}{% if request.GET.operated_by %}&operated_by={{ request.GET.operated_by }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">数量 ▲</a>
          {% else %}
            <a href="?sort=quantity&order=asc{% if request.GET.product %}&product={{ request.GET.product }}{% endif %}{% if request.GET.movement_type %}&movement_type={{ request.GET.movement_type }}{% endif %}{% if request.GET.operated_by %}&operated_by={{ request.GET.operated_by }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">数量 ▼</a>
          {% endif %}
        {% else %}
          <a href="?sort=quantity&order=asc{% if request.GET.product %}&product={{ request.GET.product }}{% endif %}{% if request.GET.movement_type %}&movement_type={{ request.GET.movement_type }}{% endif %}{% if request.GET.operated_by %}&operated_by={{ request.GET.operated_by }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">数量</a>
        {% endif %}
      </th>

      <th>
        {% if request.GET.sort == "operated_by" %}
          {% if request.GET.order == "asc" %}
            <a href="?sort=operated_by&order=desc{% if request.GET.product %}&product={{ request.GET.product }}{% endif %}{% if request.GET.movement_type %}&movement_type={{ request.GET.movement_type }}{% endif %}{% if request.GET.operated_by %}&operated_by={{ request.GET.operated_by }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">担当者 ▲</a>
          {% else %}
            <a href="?sort=operated_by&order=asc{% if request.GET.product %}&product={{ request.GET.product }}{% endif %}{% if request.GET.movement_type %}&movement_type={{ request.GET.movement_type }}{% endif %}{% if request.GET.operated_by %}&operated_by={{ request.GET.operated_by }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">担当者 ▼</a>
          {% endif %}
        {% else %}
          <a href="?sort=operated_by&order=asc{% if request.GET.product %}&product={{ request.GET.product }}{% endif %}{% if request.GET.movement_type %}&movement_type={{ request.GET.movement_type }}{% endif %}{% if request.GET.operated_by %}&operated_by={{ request.GET.operated_by }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">担当者</a>
        {% endif %}
      </th>

      <th>備考</th>
    </tr>
  </thead>
  <tbody>
    {% for h in object_list %}
    <tr>
      <td>{{ h.timestamp|date:'Y-m-d H:i' }}</td>
      <td>{{ h.product.name }}</td>
      <td>{{ h.get_movement_type_display }}</td>
      <td class="text-end">{{ h.quantity }}</td>
      <td>{{ h.operated_by }}</td>
      <td>
        {% if h.remarks|length > 30 %}
          <a href="#" class="remarks-link" data-bs-toggle="modal" data-bs-target="#remarksModal" data-remarks="{{ h.remarks|escape }}">
            {{ h.remarks|slice:":30" }}…
          </a>
        {% else %}
          {{ h.remarks }}
        {% endif %}
      </td>
    </tr>
    {% empty %}
    <tr><td colspan="6" class="text-center">履歴がありません</td></tr>
    {% endfor %}
  </tbody>
</table>
</div>

<!-- ページネーション -->
<nav aria-label="Page navigation">
  <ul class="pagination justify-content-center">
    {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.previous_page_number }}" aria-label="Previous">&laquo; 前へ</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">&laquo; 前へ</span></li>
    {% endif %}

    {% for num in page_obj.paginator.page_range %}
      {% if num == page_obj.number %}
        <li class="page-item active" aria-current="page"><span class="page-link">{{ num }}</span></li>
      {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
        <li class="page-item"><a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ num }}">{{ num }}</a></li>
      {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.next_page_number }}" aria-label="Next">次へ &raquo;</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">次へ &raquo;</span></li>
    {% endif %}
  </ul>
</nav>

<!-- 備考全文モーダル -->
<div class="modal fade" id="remarksModal" tabindex="-1" aria-labelledby="remarksModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="remarksModalLabel">備考全文</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
      </div>
      <div class="modal-body" id="remarksModalBody">
        <!-- JSで差し替え -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">閉じる</button>
      </div>
    </div>
  </div>
</div>

<!-- ツールチップ・モーダル用JS -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // ツールチップ初期化
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
      new bootstrap.Tooltip(tooltipTriggerEl)
    })

    // 備考クリックで全文モーダル表示
    var remarksLinks = document.querySelectorAll('.remarks-link')
    var remarksModalBody = document.getElementById('remarksModalBody')
    remarksLinks.forEach(function(link) {
      link.addEventListener('click', function(event) {
        event.preventDefault()
        var remarksText = this.getAttribute('data-remarks')
        remarksModalBody.textContent = remarksText
      })
    })
  })
</script>

{% endblock %}
